<!DOCTYPE html><html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Gomoku – 금수 엔진 (IndexedDB 캐시 + Issue Export)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--cell:32px;--stone:26px}
    body{font-family:sans-serif;margin:0;padding:1rem;display:flex;flex-direction:column;align-items:center;background:#faf5e7}
    #board{display:grid;grid-template-columns:repeat(15,var(--cell));grid-template-rows:repeat(15,var(--cell));border:2px solid #222;background:#e3b778}
    .cell{width:var(--cell);height:var(--cell);border:1px solid rgba(0,0,0,.25);position:relative;display:flex;align-items:center;justify-content:center}
    .cell:hover{background:rgba(255,255,255,.3);cursor:pointer}
    .stone{border-radius:50%;width:var(--stone);height:var(--stone);pointer-events:none}
    .black{background:#000}
    .white{background:#fff;border:1px solid #000}
    .hint{position:absolute;font-size:.7rem;font-weight:bold;pointer-events:none;transform:translate(-50%,-120%);white-space:nowrap}
    .hint0{color:#ff5722}
    .hint1{color:#1565c0}
    .hint2{color:#555}
    .coordX{position:absolute;bottom:0;left:2px;font-size:.55rem;color:#333;pointer-events:none}
    .coordY{position:absolute;top:1px;left:1px;font-size:.55rem;color:#333;pointer-events:none}
    #info{margin-top:1rem;font-weight:bold;font-size:1.1rem}
    #nav, #controls{display:flex;gap:.4rem;margin-top:.6rem;flex-wrap:wrap;justify-content:center}
    button{padding:.3rem .6rem;border:none;border-radius:4px;background:#444;color:#fff;cursor:pointer}
    button:disabled{opacity:.4;cursor:default}
    #analysisResult{margin-top:1rem;font-weight:bold;white-space:pre-line;text-align:center}
  </style>
</head>
<body>
<h2>오목 계산기 – 금수(열린3) 룰</h2>
<div id="info"></div>
<div id="board"></div>
<div id="nav">
  <button id="first">≪</button>
  <button id="prev">〈</button>
  <span id="moveCount">0 / 0</span>
  <button id="next">〉</button>
  <button id="last">≫</button>
  <button id="new">새 게임</button>
</div>
<div id="controls">
  깊이:<input type="number" id="depth" value="6" min="1" max="12">
  <button id="analyze">분석(Top‑3)</button>
  <button id="export">Cache 내보내기</button>
  <label style="background:#666">Cache 불러오기 <input type="file" id="import" accept="application/json" style="display:none"></label>
</div>
<div id="analysisResult"></div>
<script>
/************ IndexedDB – local cache ************/
let idb;
function openDB(){return new Promise((res,rej)=>{
  const req=indexedDB.open('gomokuCache',1);
  req.onupgradeneeded=e=>e.target.result.createObjectStore('pos',{keyPath:'hash'});
  req.onsuccess=e=>{idb=e.target.result;res();};req.onerror=()=>rej();});}
async function loadCache(hash){if(!idb)await openDB();return new Promise(r=>{const tx=idb.transaction('pos');tx.objectStore('pos').get(hash).onsuccess=e=>r(e.target.result);});}
async function saveCache(hash,data){if(!idb)await openDB();const tx=idb.transaction('pos','readwrite');tx.objectStore('pos').put({hash,...data});}
async function dumpCache(){if(!idb)await openDB();return new Promise(r=>{const out=[];const tx=idb.transaction('pos');tx.objectStore('pos').openCursor().onsuccess=e=>{const cur=e.target.result;if(cur){out.push(cur.value);cur.continue();}else r(out);};});}
async function importCache(arr){if(!idb)await openDB();const tx=idb.transaction('pos','readwrite');arr.forEach(o=>tx.objectStore('pos').put(o));}
/************ CONSTANTS & HELPERS ************/
const SIZE=15,EMPTY=0,BLACK=1,WHITE=2;
const dirs=[[1,0],[0,1],[1,1],[1,-1]];
const rand32=_=>Math.floor(Math.random()*0x100000000);
const Z=Array.from({length:SIZE},()=>Array.from({length:SIZE},()=>[rand32(),rand32()]));
function inside(x,y){return x>=0&&x<SIZE&&y>=0&&y<SIZE;}
function coordName(x,y){return String.fromCharCode(65+x)+(y+1);} // A1
function hashBoard(b){let h=0;for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){const v=b[y][x];if(v===BLACK)h^=Z[y][x][0];else if(v===WHITE)h^=Z[y][x][1];}return h.toString(16);} // hex key
/************ UI STATE ************/
let board,moveHistory,current,viewIdx,suggestions=[];
resetGame();
const boardEl=document.getElementById('board');
/************ RENDER ************/
function render(){boardEl.innerHTML='';const sugMap=new Map();suggestions.forEach((s,i)=>sugMap.set(s.x+','+s.y,{score:s.score,rank:i}));for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){const cell=document.createElement('div');cell.className='cell';cell.dataset.x=x;cell.dataset.y=y;if(board[y][x]){const st=document.createElement('div');st.className='stone '+(board[y][x]===BLACK?'black':'white');cell.appendChild(st);}if(y===SIZE-1){const lx=document.createElement('span');lx.className='coordX';lx.textContent=String.fromCharCode(65+x);cell.appendChild(lx);}if(x===0){const ly=document.createElement('span');ly.className='coordY';ly.textContent=y+1;cell.appendChild(ly);}const s=sugMap.get(x+','+y);if(s){const h=document.createElement('span');h.className='hint hint'+s.rank;h.textContent=(s.rank+1)+':'+s.score;cell.appendChild(h);}boardEl.appendChild(cell);}document.getElementById('info').textContent=viewIdx===moveHistory.length?(current===BLACK?'흑':'백')+' 차례':'리플레이 – '+viewIdx+'수';updateNav();}
function updateNav(){document.getElementById('moveCount').textContent=viewIdx+' / '+moveHistory.length;['first','prev'].forEach(id=>document.getElementById(id).disabled=!viewIdx);['next','last'].forEach(id=>document.getElementById(id).disabled=viewIdx===moveHistory.length);}  
/************ GAME LOGIC ************/
function resetGame(){board=Array.from({length:SIZE},()=>Array(SIZE).fill(EMPTY));moveHistory=[];current=BLACK;viewIdx=0;suggestions=[];render();document.getElementById('analysisResult').textContent='';}
function rebuild(idx){board=Array.from({length:SIZE},()=>Array(SIZE).fill(EMPTY));for(let i=0;i<idx;i++){const m=moveHistory[i];board[m.y][m.x]=m.color;}current=idx%2?WHITE:BLACK;}
function checkWin(b,x,y){const col=b[y][x];for(const[dx,dy]of dirs){let cnt=1;for(const dir of[-1,1]){let nx=x+dx*dir,ny=y+dy*dir;while(inside(nx,ny)&&b[ny][nx]===col){cnt++;nx+=dx*dir;ny+=dy*dir;}}if(cnt>=5)return true;}return false;}
function patternLine(b,x,y,dx,dy,col){let str='';for(let k=-4;k<=4;k++){const nx=x+dx*k,ny=y+dy*k;if(!inside(nx,ny))str+='X';else{const v=b[ny][nx];str+=v===EMPTY?'_':(v===BLACK?'B':'W');}}return str;}
function isOpenThreeAfter(b,x,y,color){b[y][x]=color;const tgt=color===BLACK?'B':'W';let ok=false;for(const[dx,dy]of dirs){const line=patternLine(b,x,y,dx,dy,color).replace(/B|W/g,m=>m===tgt?tgt:'O');if(/_BBB_/.test(line)){ok=true;break;}}b[y][x]=EMPTY;return ok;}
function forbidden(b,x,y,c){return isOpenThreeAfter(b,x,y,c);}  
/************ SEARCH ************/
function evalSide(b,t){let s=0;const add=v=>s+=v;const scan=a=>{for(let i=0;i<a.length;){if(a[i]!==t){i++;continue;}let j=i;while(j<a.length&&a[j]===t)j++;const len=j-i,lo=i-1>=0&&a[i-1]===EMPTY,ro=j<a.length&&a[j]===EMPTY;if(len>=5)add(1e5);else if(len===4){if(lo&&ro)add(1e4);else if(lo||ro)add(5e3);}else if(len===3){if(lo&&ro)add(1e3);else if(lo||ro)add(400);}else if(len===2){if(lo&&ro)add(100);else if(lo||ro)add(40);}else if(len===1&&lo&&ro)add(10);i=j;}};for(let y=0;y<SIZE;y++)scan(b[y]);for(let x=0;x<SIZE;x++){const col=[];for(let y=0;y<SIZE;y++)col.push(b[y][x]);scan(col);}for(let k=0;k<SIZE;k++){const d1=[],d2=[],a1=[],a2=[];for(let y=0,x=k;y<SIZE&&x<SIZE;y++,x++)d1.push(b[y][x]);scan(d1);if(k)for(let y=k,x=0;y<SIZE&&x<SIZE;y++,x++)d2.push(b[y][x]);scan(d2);for(let y=SIZE-1,x=k;y>=0&&x<SIZE;y--,x++)a1.push(b[y][x]);scan(a1);if(k)for(let y=SIZE-1-k,x=0;y>=0&&x<SIZE;y--,x++)a2.push(b[y][x]);scan(a2);}return s;}
function staticEval(b,p){return evalSide(b,p)-evalSide(b,p===BLACK?WHITE:BLACK);}  
const TT=new Map();const hist=[];const WIN=2e5;
const rand32b=_=>Math.floor(Math.random()*0x100000000);
function ab(b,h,p,d,md,a,beta){if(d&&checkWin(b,hist[d-1].x,hist[d-1].y))return WIN-d;const t=TT.get(h);if(t&&t.d>=md-d)return t.v;if(d===md)return staticEval(b,p);
  let best=-1e9;for(const [x,y] of orderedMoves(b,p)){if(forbidden(b,x,y,p))continue;b[y][x]=p;hist[d]={x,y};const nh=h^(p===BLACK?Z[y][x][0]:Z[y][x][1]);const s=-ab(b,nh,p===BLACK?WHITE:BLACK,d+1,md,-beta,-a);b[y][x]=0;if(s>best)best=s;if(best>a)a=best;if(a>=beta)break;}TT.set(h,{d:md-d,v:best});return best;}
function orderedMoves(b,p){const w=[],r=[];for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){if(b[y][x])continue;let near=false;for(let dy=-1;dy<=1&&!near;dy++)for(let dx=-1;dx<=1;dx++){const nx=x+dx,ny=y+dy;if(inside(nx,ny)&&b[ny][nx]){near=true;break;}}if(!near)continue;if(!forbidden(b,x,y,p)){b[y][x]=p;if(checkWin(b,x,y))w.unshift([x,y]);else r.push([x,y]);b[y][x]=0;}}
  return w.concat(r);}  
async function analyze(depth){const key=hashBoard(board);const cached=await loadCache(key);if(cached&&cached.depth>=depth){suggestions=cached.top3;return cached.top3;}hist.length=0;const mv=orderedMoves(board,current);const res=[];for(const [x,y] of mv){if(forbidden(board,x,y,current))continue;board[y][x]=current;hist[0]={x,y};const h=key^(current===BLACK?Z[y][x][0]:Z[y][x][1]);const score=-ab(board,h,current===BLACK?WHITE:BLACK,1,depth,-1e9,1e9);board[y][x]=0;res.push({x,y,score});}
  res.sort((a,b)=>b.score-a.score);const top3=res.slice(0,3);await saveCache(key,{depth,top3});suggestions=top3;return top3;}
/************ UI EVENTS ************/
boardEl.addEventListener('click',e=>{if(viewIdx!==moveHistory.length)return;const c=e.target.closest('.cell');if(!c)return;const x=+c.dataset.x,y=+c.dataset.y;if(board[y][x])return;if(forbidden(board,x,y,current)){alert('금수');return;}moveHistory.push({x,y,color:current});board[y][x]=current;viewIdx++;suggestions=[];if(checkWin(board,x,y)){render();alert((current===BLACK?'흑':'백')+' 승리!');}else{current=current===BLACK?WHITE:BLACK;render();}});
['first','prev','next','last'].forEach(id=>document.getElementById(id).addEventListener('click',()=>{if(id==='first')viewIdx=0;else if(id==='prev'&&viewIdx)viewIdx--;else if(id==='next'&&viewIdx<moveHistory.length)viewIdx++;else if(id==='last')viewIdx=moveHistory.length;rebuild(viewIdx);suggestions=[];render();}));
document.getElementById('new').addEventListener('click',()=>{if(confirm('새 게임?'))resetGame();});
document.getElementById('analyze').addEventListener('click',async()=>{if(viewIdx!==moveHistory.length)return alert('최신 수에서만 분석');const d=+document.getElementById('depth').value||6;const top=await analyze(d);render();let txt='TOP‑3 (깊이 '+d+')\n';top.forEach((s,i)=>txt+=(i+1)+'. '+coordName(s.x,s.y)+' '+s.score+'\n');document.getElementById('analysisResult').textContent=txt;});
/************ Export / Import ************/
document.getElementById('export').addEventListener('click',async()=>{const data=await dumpCache();const str=JSON.stringify(data);const blob=new Blob([str],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='gomokuCache.json';a.click();URL.revokeObjectURL(url);
  const issueBody=encodeURIComponent("```json\n"+str+"\n```\n\n(자동 업로드 캐시)");const link=`https://github.com/USERNAME/REPO/issues/new?title=Upload%20cache&body=${issueBody}`;setTimeout(()=>alert('GitHub Issue 업로드 링크가 복사됩니다.\n\n' + link),100);
});document.getElementById('import').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const arr=JSON.parse(ev.target.result);importCache(arr).then(()=>alert('캐시 병합 완료'));}catch{alert('JSON 파싱 실패');}};r.readAsText(f);}); /************ INIT ************/ render(); </script>

</body>
</html>
