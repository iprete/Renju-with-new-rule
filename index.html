<!DOCTYPE html><html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Renju with New Rule – Open‑Three Forbidden Engine</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--cell:32px;--stone:26px}
    body{font-family:sans-serif;margin:0;padding:1rem;display:flex;flex-direction:column;align-items:center;background:#faf5e7}
    #board{display:grid;grid-template-columns:repeat(15,var(--cell));grid-template-rows:repeat(15,var(--cell));border:2px solid #222;background:#e3b778}
    .cell{width:var(--cell);height:var(--cell);border:1px solid rgba(0,0,0,.25);position:relative;display:flex;align-items:center;justify-content:center}
    .cell:hover{background:rgba(255,255,255,.3);cursor:pointer}
    .stone{border-radius:50%;width:var(--stone);height:var(--stone);pointer-events:none}
    .black{background:#000}
    .white{background:#fff;border:1px solid #000}
    .hint{position:absolute;transform:translate(-50%,-120%);font-size:.7rem;font-weight:bold;pointer-events:none;white-space:nowrap}
    .hint0{color:#ff5722}.hint1{color:#1565c0}.hint2{color:#555}
    .coordX{position:absolute;bottom:0;left:2px;font-size:.55rem;color:#333;pointer-events:none}
    .coordY{position:absolute;top:1px;left:1px;font-size:.55rem;color:#333;pointer-events:none}
    #info{margin-top:1rem;font-weight:bold;font-size:1.1rem}
    #nav,#controls{display:flex;gap:.4rem;margin-top:.6rem;flex-wrap:wrap;justify-content:center}
    button{padding:.3rem .6rem;border:none;border-radius:4px;background:#444;color:#fff;cursor:pointer}
    button:disabled{opacity:.4}
    #analysisResult{margin-top:1rem;font-weight:bold;white-space:pre-line;text-align:center}
  </style>
</head>
<body>
<h2>Renju – 금수(열린 연속3) 엔진</h2>
<div id="info"></div>
<div id="board"></div>
<div id="nav">
  <button id="first">≪</button><button id="prev">〈</button>
  <span id="moveCount">0 / 0</span>
  <button id="next">〉</button><button id="last">≫</button>
  <button id="new">새 게임</button>
</div>
<div id="controls">
  깊이:<input type="number" id="depth" value="6" min="1" max="12" />
  <button id="analyze">분석(Top‑3)</button>
  <button id="export">Cache 내보내기</button>
  <label style="background:#666">Cache 불러오기 <input type="file" id="import" accept="application/json" hidden></label>
</div>
<div id="analysisResult"></div>
<script>
/************ IndexedDB local cache ************/
let idb;
function openDB(){return new Promise((res,rej)=>{
  const req=indexedDB.open('gomokuCache',1);
  req.onupgradeneeded=e=>e.target.result.createObjectStore('pos',{keyPath:'hash'});
  req.onsuccess=e=>{idb=e.target.result;res();};
  req.onerror=rej;
});}
function tx(mode){return idb.transaction('pos',mode).objectStore('pos');}
async function loadCache(hash){if(!idb)await openDB();return new Promise(r=>tx('readonly').get(hash).onsuccess=e=>r(e.target.result));}
async function saveCache(hash,data){if(!idb)await openDB();tx('readwrite').put({hash,...data});}
async function dumpCache(){if(!idb)await openDB();return new Promise(r=>{const out=[];tx('readonly').openCursor().onsuccess=e=>{const c=e.target.result;if(c){out.push(c.value);c.continue();}else r(out);};});}
async function importCache(arr){if(!idb)await openDB();const store=tx('readwrite');arr.forEach(o=>store.put(o));}
/************ Remote cache.json merge ************/
async function fetchRemoteCache(){try{const res=await fetch('cache.json',{cache:'no-store'});if(!res.ok) return;const data=await res.json();if(Array.isArray(data)&&data.length){await importCache(data);console.log('remote cache merged',data.length);}}catch(e){console.warn('remote cache fetch failed',e);} }
/************ Constants & helpers ************/
const SIZE=15,EMPTY=0,BLACK=1,WHITE=2;
const dirs=[[1,0],[0,1],[1,1],[1,-1]];
function inside(x,y){return x>=0&&x<SIZE&&y>=0&&y<SIZE;}
function coord(x,y){return String.fromCharCode(65+x)+(y+1);} // A1
// Zobrist
const rand32=_=>Math.floor(Math.random()*0x100000000);
const Z=Array.from({length:SIZE},()=>Array.from({length:SIZE},()=>[rand32(),rand32()]));
function hashBoard(b){let h=0;for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){const v=b[y][x];if(v===BLACK)h^=Z[y][x][0];else if(v===WHITE)h^=Z[y][x][1];}return h.toString(16);}  
/************ Global state ************/
let board,moveHistory,current,viewIdx,suggestions=[];
const boardEl=document.getElementById('board');
/************ Rendering ************/
function render(){boardEl.innerHTML='';const hintMap=new Map();suggestions.forEach((s,i)=>hintMap.set(s.x+","+s.y,{score:s.score,rank:i}));
  for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){
    const cell=document.createElement('div');cell.className='cell';cell.dataset.x=x;cell.dataset.y=y;
    if(board[y][x]){const st=document.createElement('div');st.className='stone '+(board[y][x]===BLACK?'black':'white');cell.appendChild(st);}    
    if(y===SIZE-1){const lx=document.createElement('span');lx.className='coordX';lx.textContent=String.fromCharCode(65+x);cell.appendChild(lx);}    
    if(x===0){const ly=document.createElement('span');ly.className='coordY';ly.textContent=y+1;cell.appendChild(ly);}    
    const h=hintMap.get(x+","+y);if(h){const s=document.createElement('span');s.className='hint hint'+h.rank;s.textContent=(h.rank+1)+':'+h.score;cell.appendChild(s);}    
    boardEl.appendChild(cell);
  }
  document.getElementById('info').textContent=(viewIdx===moveHistory.length?(current===BLACK?'흑':'백')+' 차례':'리플레이 – '+viewIdx+'수');
  document.getElementById('moveCount').textContent=viewIdx+' / '+moveHistory.length;
  document.getElementById('first').disabled=document.getElementById('prev').disabled=!viewIdx;
  document.getElementById('next').disabled=document.getElementById('last').disabled=viewIdx===moveHistory.length;
}
/************ Game helpers ************/
function resetGame(){board=Array.from({length:SIZE},()=>Array(SIZE).fill(EMPTY));moveHistory=[];current=BLACK;viewIdx=0;suggestions=[];render();document.getElementById('analysisResult').textContent='';}
function rebuild(idx){board=Array.from({length:SIZE},()=>Array(SIZE).fill(EMPTY));for(let i=0;i<idx;i++){const m=moveHistory[i];board[m.y][m.x]=m.color;}current=idx%2?WHITE:BLACK;}
function checkWin(b,x,y){const col=b[y][x];for(const[dx,dy]of dirs){let cnt=1;for(const dir of[-1,1]){let nx=x+dx*dir,ny=y+dy*dir;while(inside(nx,ny)&&b[ny][nx]===col){cnt++;nx+=dx*dir;ny+=dy*dir;}}if(cnt>=5)return true;}return false;}
function linePattern(b,x,y,dx,dy){let str='';for(let k=-4;k<=4;k++){const nx=x+dx*k,ny=y+dy*k;if(!inside(nx,ny))str+='X';else{const v=b[ny][nx];str+=v===EMPTY?'_':(v===BLACK?'B':'W');}}return str;}
function openThree(b,x,y,c){b[y][x]=c;const tgt=c===BLACK?'B':'W';let ok=false;for(const[dx,dy]of dirs){const line=linePattern(b,x,y,dx,dy).replace(/B|W/g,m=>m===tgt?tgt:'O');if(/_BBB_/.test(line)){ok=true;break;}}b[y][x]=0;return ok;}
function forbidden(b,x,y,c){return openThree(b,x,y,c);}  
function nearby(b,x,y){for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){if(!dx&&!dy)continue;const nx=x+dx,ny=y+dy;if(inside(nx,ny)&&b[ny][nx])return true;}return false;}
/************ Search (alpha–beta) ************/
const TT=new Map();const hist=[];const WIN=2e5;
function evalSide(b,t){let s=0;const add=v=>s+=v;const scan=a=>{for(let i=0;i<a.length;){if(a[i]!==t){i++;continue;}let j=i;while(j<a.length&&a[j]===t)j++;const len=j-i,lo=i-1>=0&&a[i-1]===EMPTY,ro=j<a.length&&a[j]===EMPTY;if(len>=5)add(1e5);else if(len===4){if(lo&&ro)add(1e4);else if(lo||ro)add(5e3);}else if(len===3){if(lo&&ro)add(1e3);else if(lo||ro)add(400);}else if(len===2){if(lo&&ro)add(100);else if(lo||ro)add(40);}else if(len===1&&lo&&ro)add(10);i=j;}};
  for(let y=0;y<SIZE;y++)scan(b[y]);for(let x=0;x<SIZE;x++){const col=[];for(let y=0;y<SIZE;y++)col.push(b[y][x]);scan(col);}for(let k=0;k<SIZE;k++){const d1=[],d2=[],a1=[],a2=[];for(let y=0,x=k;y<SIZE&&x<SIZE;y++,x++)d1.push(b[y][x]);scan(d1);if(k)for(let y=k,x=0;y<SIZE&&x<SIZE;y++,x++)d2.push(b[y][x]);scan(d2);for(let y=SIZE-1,x=k;y>=0&&x<SIZE;y--,x++)a1.push(b[y][x]);scan(a1);if(k)for(let y=SIZE-1-k,x=0;y>=0&&x<SIZE;y--,x++)a2.push(b[y][x]);scan(a2);}return s;}
function staticEval(b,p){return evalSide(b,p)-evalSide(b,p===BLACK?WHITE:BLACK);}  
function alphaBeta(b,h,p,d,maxD,alpha,beta){if(d&&checkWin(b,hist[d-1].x,hist[d-1].y))return WIN-d;const tt=TT.get(h);if(tt&&tt.depth>=maxD-d)return tt.val;if(d===maxD)return staticEval(b,p);
  let best=-1e9;for(const [x,y] of orderedMoves(b,p)){
    if(forbidden(b,x,y,p))continue;
    b[y][x]=p;hist[d]={x,y};const nh=h^(p===BLACK?Z[y][x][0]:Z[y][x][1]);
    const score=-alphaBeta(b,nh,p===BLACK?WHITE:BLACK,d+1,maxD,-beta,-alpha);
    b[y][x]=0;if(score>best)best=score;if(best>alpha)alpha=score;if(alpha>=beta)break;}
  TT.set(h,{depth:maxD-d,val:best});return best;}
function orderedMoves(b,p){const win=[],rest=[];for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){if(b[y][x]||!nearby(b,x,y))continue;if(forbidden(b,x,y,p))continue;b[y][x]=p;if(checkWin(b,x,y))win.unshift([x,y]);else rest.push([x,y]);b[y][x]=0;}return win.concat(rest);}  
async function analyze(depth){const key=hashBoard(board);const cached=await loadCache(key);if(cached&&cached.depth>=depth){suggestions=cached.top3;return cached.top3;}
  const res=[];hist.length=0;
  for(const [x,y] of orderedMoves(board,current)){
    board[y][x]=current;hist[0]={x,y};const h=key^(current===BLACK?Z[y][x][0]:Z[y][x][1]);const score=-alphaBeta(board,h,current===BLACK?WHITE:BLACK,1,depth,-1e9,1e9);board[y][x]=0;res.push({x,y,score});}
  res.sort((a,b)=>b.score-a.score);const top3=res.slice(0,3);await saveCache(key,{depth,top3});suggestions=top3;return top3;}
/************ UI events ************/
boardEl.addEventListener('click',e=>{if(viewIdx!==moveHistory.length)return;const cell=e.target.closest('.cell');if(!cell)return;const x=+cell.dataset.x,y=+cell.dataset.y;if(board[y][x])return;if(forbidden(board,x,y,current)){alert('금수: 열린 연속3');return;}moveHistory.push({x,y,color:current});board[y][x]=current;viewIdx++;suggestions=[];if(checkWin(board,x,y)){render();alert((current===BLACK?'흑':'백')+' 승리!');}else{current=current===BLACK?WHITE:BLACK;render();}});
['first','prev','next','last'].forEach(id=>document.getElementById(id).addEventListener('click',()=>{if(id==='first')viewIdx=0;else if(id==='prev'&&viewIdx)viewIdx--;else if(id==='next'&&viewIdx<moveHistory.length)viewIdx++;else if(id==='last')viewIdx=moveHistory.length;rebuild(viewIdx);suggestions=[];render();}));
document.getElementById('new').addEventListener('click',()=>{if(confirm('새 게임을 시작할까요?'))resetGame();});
document.getElementById('analyze').addEventListener('click',async()=>{if(viewIdx!==moveHistory.length)return alert('최신 수에서 분석 가능');const d=+document.getElementById('depth').value||6;const top=await analyze(d);render();let s='TOP‑3 (깊이 '+d+')\n';top.forEach((m,i)=>s+=(i+1)+'. '+coord(m.x,m.y)+' '+m.score+'\n');document.getElementById('analysisResult').textContent=s;});
document.getElementById('export').addEventListener('click',async()=>{const data=await dumpCache();const blob=new Blob([JSON.stringify(data)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='gomokuCache.json';a.click();URL.revokeObjectURL(url);
  const body=encodeURIComponent('```json\n'+JSON.stringify(data,null,2)+'\n```');const link=`https://github.com/iprete/Renju-with-new-rule/issues/new?title=Upload%20cache&body=${body}`;setTimeout(()=>prompt('Issue 업로드 링크를 복사해 새 창에 붙여넣어 제출하세요:',link),200);
});
document.getElementById('import').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const rd=new FileReader();rd.onload=ev=>{try{const arr=JSON.parse(ev.target.result);importCache(arr).then(()=>alert('병합 완료'));}catch(err){alert('JSON 파싱 오류');}};rd.readAsText(f);});
/************ INITIALIZATION ************/
(async()=>{
  await openDB();
  await fetchRemoteCache();
  resetGame();
})();
</script>
</body>
</html>
